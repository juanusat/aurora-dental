<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="reporte07" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="ccf9b272-0c34-4b8f-a578-e96511e774c3">
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<queryString>
		<![CDATA[WITH stats AS (
  SELECT
    t.trabajador_id   AS medico_id,
    p.nombre || ' ' || p.apellido AS medico,
    COUNT(c.cita_id)  AS total_citas,
    COUNT( CASE
             WHEN am.modificado_en > am.fecha_realizacion THEN 1
           END )       AS citas_modificadas
  FROM cita c
  JOIN acto_medico am ON c.cita_id = am.cita_id
  JOIN trabajador  t  ON c.medico_id = t.trabajador_id
  JOIN persona     p  ON t.persona_id = p.persona_id
  WHERE c.estado = 'realizada'
  GROUP BY t.trabajador_id, p.nombre, p.apellido
)
SELECT
  medico_id,
  medico,
  total_citas,
  citas_modificadas,
  -- Calculamos el % y lo redondeamos a 2 decimales
  ROUND(citas_modificadas::NUMERIC / NULLIF(total_citas,0) * 100, 2) AS porcentaje_modificacion
FROM stats;]]>
	</queryString>
	<field name="medico_id" class="java.lang.Integer"/>
	<field name="medico" class="java.lang.String"/>
	<field name="total_citas" class="java.lang.Long"/>
	<field name="citas_modificadas" class="java.lang.Long"/>
	<field name="porcentaje_modificacion" class="java.math.BigDecimal"/>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="86" splitType="Stretch">
			<staticText>
				<reportElement x="161" y="25" width="229" height="33" uuid="f3e1f7ae-02db-4237-ac33-7c6015ac6bbc"/>
				<textElement textAlignment="Center">
					<font size="16" isBold="true"/>
				</textElement>
				<text><![CDATA[Actos médicos modificados]]></text>
			</staticText>
			<textField pattern="EEEEE dd MMMMM yyyy">
				<reportElement x="397" y="63" width="156" height="20" uuid="50f0573a-8c91-4c1b-9228-22dfa430eb9a"/>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<pageHeader>
		<band height="35" splitType="Stretch"/>
	</pageHeader>
	<columnHeader>
		<band height="29" splitType="Stretch">
			<line>
				<reportElement x="38" y="28" width="475" height="1" uuid="4b69d435-2729-4202-a55b-620ab387f34d"/>
			</line>
			<staticText>
				<reportElement x="38" y="3" width="100" height="20" uuid="7a9c996d-a4f3-44bb-a719-c913160dfc35"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Médico]]></text>
			</staticText>
			<staticText>
				<reportElement x="221" y="3" width="73" height="20" uuid="ff456c73-afa7-4a47-b5ac-2235f4497386"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Total citas]]></text>
			</staticText>
			<staticText>
				<reportElement x="324" y="3" width="89" height="20" uuid="e2c61ec5-cc0e-4a94-8664-041ebbee85ac"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Citas modificadas]]></text>
			</staticText>
			<staticText>
				<reportElement x="443" y="3" width="71" height="20" uuid="298c1b5d-1537-483d-a00b-1a65b96893a7"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Porcentaje]]></text>
			</staticText>
		</band>
	</columnHeader>
	<detail>
		<band height="38" splitType="Stretch">
			<line>
				<reportElement x="39" y="33" width="475" height="1" uuid="74fa83c4-42ee-479c-a0a8-770b6d434fdf"/>
			</line>
			<textField>
				<reportElement x="38" y="10" width="144" height="20" uuid="1f5bad71-5b94-4c79-ac27-53154c463311"/>
				<textFieldExpression><![CDATA[$F{medico}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="221" y="10" width="73" height="20" uuid="42248cb6-934c-4db7-a557-a480e74901d8"/>
				<textFieldExpression><![CDATA[$F{total_citas}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="324" y="10" width="89" height="20" uuid="3e4e82f6-178d-47e6-927c-eaceaa86f588"/>
				<textFieldExpression><![CDATA[$F{citas_modificadas}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="442" y="10" width="71" height="20" uuid="0fc97012-4616-45c4-9888-3b142999594d"/>
				<textFieldExpression><![CDATA[$F{porcentaje_modificacion}+"%"]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<columnFooter>
		<band height="45" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="54" splitType="Stretch">
			<staticText>
				<reportElement x="16" y="23" width="141" height="20" uuid="06c12ad3-3089-4202-9cdf-e814a235b225"/>
				<text><![CDATA[Creado por: Antonio Errea]]></text>
			</staticText>
			<textField>
				<reportElement x="413" y="23" width="80" height="20" uuid="4f4acd61-96d3-490b-9b21-66de07134367"/>
				<textElement textAlignment="Right"/>
				<textFieldExpression><![CDATA["Página "+$V{PAGE_NUMBER}+" de"]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement x="493" y="23" width="40" height="20" uuid="eb7d340b-c901-40a3-811c-84edf3449214"/>
				<textFieldExpression><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="334" splitType="Stretch">
			<barChart>
				<chart>
					<reportElement x="6" y="10" width="542" height="314" uuid="0b017c11-18b9-477c-a2cf-f3767ef5d0ba"/>
					<chartTitle/>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<categoryDataset>
					<categorySeries>
						<seriesExpression><![CDATA["Actos médicos modificados"]]></seriesExpression>
						<categoryExpression><![CDATA[$F{medico}]]></categoryExpression>
						<valueExpression><![CDATA[$F{citas_modificadas}]]></valueExpression>
					</categorySeries>
				</categoryDataset>
				<barPlot>
					<plot/>
					<itemLabel/>
					<categoryAxisLabelExpression><![CDATA["Médicos"]]></categoryAxisLabelExpression>
					<categoryAxisFormat>
						<axisFormat/>
					</categoryAxisFormat>
					<valueAxisLabelExpression><![CDATA["Cantidad citas modificadas"]]></valueAxisLabelExpression>
					<valueAxisFormat>
						<axisFormat/>
					</valueAxisFormat>
				</barPlot>
			</barChart>
		</band>
	</summary>
</jasperReport>
