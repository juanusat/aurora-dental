<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="reporte01_Barboza" language="groovy" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="c1f33b9b-d7fc-4585-a84d-a119e029313b">
	<property name="ireport.zoom" value="1.2100000000000009"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="MesSeleccionado" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="AnioSeleccionado" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[WITH payment_weeks AS (
    SELECT
        EXTRACT(YEAR FROM p.fecha_hora) AS payment_year,
        EXTRACT(MONTH FROM p.fecha_hora) AS payment_month,
        EXTRACT(DAY FROM p.fecha_hora) AS payment_day,
        p.monto,
        p.cita_id, -- Incluimos cita_id para el conteo de citas únicas
        CASE
            WHEN EXTRACT(DAY FROM p.fecha_hora) BETWEEN 1 AND 7 THEN '01-07'
            WHEN EXTRACT(DAY FROM p.fecha_hora) BETWEEN 8 AND 14 THEN '08-14'
            WHEN EXTRACT(DAY FROM p.fecha_hora) BETWEEN 15 AND 21 THEN '15-21'
            WHEN EXTRACT(DAY FROM p.fecha_hora) >= 22 THEN
                '22-' || EXTRACT(DAY FROM (date_trunc('month', p.fecha_hora) + interval '1 month - 1 day'))::text
            ELSE 'Otros'
        END AS custom_week_label,
        CASE
            WHEN EXTRACT(DAY FROM p.fecha_hora) BETWEEN 1 AND 7 THEN 1
            WHEN EXTRACT(DAY FROM p.fecha_hora) BETWEEN 8 AND 14 THEN 2
            WHEN EXTRACT(DAY FROM p.fecha_hora) BETWEEN 15 AND 21 THEN 3
            WHEN EXTRACT(DAY FROM p.fecha_hora) >= 22 THEN 4
            ELSE 99
        END AS custom_week_order
    FROM
        pago AS p
    WHERE
        p.estado = 'correcto'
        AND EXTRACT(MONTH FROM p.fecha_hora) = $P{MesSeleccionado}
        AND EXTRACT(YEAR FROM p.fecha_hora) = $P{AnioSeleccionado}
)
SELECT
    payment_year AS Anio,
    CASE payment_month
        WHEN 1 THEN 'Enero'
        WHEN 2 THEN 'Febrero'
        WHEN 3 THEN 'Marzo'
        WHEN 4 THEN 'Abril'
        WHEN 5 THEN 'Mayo'
        WHEN 6 THEN 'Junio'
        WHEN 7 THEN 'Julio'
        WHEN 8 THEN 'Agosto'
        WHEN 9 THEN 'Septiembre'
        WHEN 10 THEN 'Octubre'
        WHEN 11 THEN 'Noviembre'
        WHEN 12 THEN 'Diciembre'
    END AS Mes,
    custom_week_label AS Semana,
    COUNT(DISTINCT cita_id) AS Cantidad_citas_Pagadas, -- Nueva columna para el conteo de citas únicas
    SUM(monto) AS Ganancias_Totales
FROM
    payment_weeks
GROUP BY
    payment_year,
    payment_month,
    custom_week_label,
    custom_week_order
ORDER BY
    payment_year,
    payment_month,
    custom_week_order;]]>
	</queryString>
	<field name="anio" class="java.math.BigDecimal"/>
	<field name="mes" class="java.lang.String"/>
	<field name="semana" class="java.lang.String"/>
	<field name="cantidad_citas_pagadas" class="java.lang.Long"/>
	<field name="ganancias_totales" class="java.math.BigDecimal"/>
	<variable name="TotalMensualGanancias" class="java.lang.String"/>
	<variable name="ganancias_totales_1" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{ganancias_totales}]]></variableExpression>
	</variable>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="79" splitType="Stretch">
			<staticText>
				<reportElement x="105" y="18" width="304" height="49" uuid="c1e0db79-cc17-4839-863e-f46441cd0dbf"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="18" isBold="true"/>
				</textElement>
				<text><![CDATA[Ganancias por mes y semana]]></text>
			</staticText>
		</band>
	</title>
	<pageHeader>
		<band height="20" splitType="Stretch"/>
	</pageHeader>
	<columnHeader>
		<band height="26" splitType="Stretch">
			<staticText>
				<reportElement x="5" y="0" width="100" height="20" uuid="6d518a8a-bccd-490c-a859-1fa0d54c617b"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[AÑO]]></text>
			</staticText>
			<staticText>
				<reportElement x="115" y="0" width="100" height="20" uuid="b272fd50-60d1-4e98-8e09-b22dfa27ee5a"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[MES]]></text>
			</staticText>
			<staticText>
				<reportElement x="227" y="0" width="100" height="20" uuid="72d5bb57-9e38-4fc6-b8cf-b2bb55dd85f6"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[SEMANA]]></text>
			</staticText>
			<staticText>
				<reportElement x="341" y="0" width="68" height="20" uuid="7f96847b-1c00-4fb9-a9bf-b903e200ee5f"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[CANT. CITAS]]></text>
			</staticText>
			<staticText>
				<reportElement x="428" y="0" width="115" height="20" uuid="a04439d1-4b01-4458-9a06-d757351e1e0d"/>
				<textElement verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[GANANCIA SEMANAL]]></text>
			</staticText>
			<line>
				<reportElement x="5" y="20" width="538" height="1" uuid="0582bb5b-8a7d-44a2-96c7-13d331c733d2"/>
				<graphicElement>
					<pen lineStyle="Solid"/>
				</graphicElement>
			</line>
		</band>
	</columnHeader>
	<detail>
		<band height="28" splitType="Stretch">
			<textField>
				<reportElement x="5" y="0" width="100" height="20" uuid="716cc48b-1aca-4f59-89a0-5dad5404c039"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{anio}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="115" y="0" width="100" height="20" uuid="24728737-e4ad-43e7-81db-6b812a73144f"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{mes}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="227" y="0" width="100" height="20" uuid="cfbcf96f-e049-4600-bf38-33a127f3252d"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{semana}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="341" y="0" width="68" height="20" uuid="d70920ee-a9fc-44de-adcf-a9eddcccb8e9"/>
				<textElement textAlignment="Center" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{cantidad_citas_pagadas}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="443" y="0" width="100" height="20" uuid="2923a063-1b6e-49a0-88bc-b2553fee4dc5"/>
				<textElement textAlignment="Right" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$F{ganancias_totales}]]></textFieldExpression>
			</textField>
			<line>
				<reportElement x="5" y="20" width="538" height="1" uuid="a93e6809-fe1d-4fa3-ae1f-f2fe54e13ca7"/>
				<graphicElement>
					<pen lineStyle="Dotted"/>
				</graphicElement>
			</line>
		</band>
	</detail>
	<columnFooter>
		<band height="16" splitType="Stretch"/>
	</columnFooter>
	<pageFooter>
		<band height="43" splitType="Stretch">
			<textField>
				<reportElement x="409" y="10" width="80" height="20" uuid="71dbd450-02d9-4a16-b8f5-7070a12a9b97"/>
				<textElement textAlignment="Right"/>
				<textFieldExpression><![CDATA["Página "+$V{PAGE_NUMBER}+" de"]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="10" y="10" width="153" height="20" uuid="7c7af750-7706-405e-8c39-0f9111dc79cd"/>
				<text><![CDATA[Creado por: Luis Barboza.]]></text>
			</staticText>
			<textField evaluationTime="Report">
				<reportElement x="492" y="10" width="40" height="20" uuid="52442e4d-1667-48f7-9ec4-7eb82d309501"/>
				<textFieldExpression><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
	<summary>
		<band height="243" splitType="Stretch">
			<textField>
				<reportElement x="472" y="13" width="71" height="20" uuid="7c04babb-dbc1-4e5b-9b6c-9e7f28cd9750"/>
				<textElement textAlignment="Right" verticalAlignment="Middle"/>
				<textFieldExpression><![CDATA[$V{ganancias_totales_1}]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="353" y="13" width="119" height="20" uuid="1b532b01-a6de-41ca-80a5-1c2dddf4e80e"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Ganancias mensuales:]]></text>
			</staticText>
			<barChart>
				<chart theme="default">
					<reportElement x="151" y="51" width="258" height="172" uuid="0f282323-fa45-46f1-819f-e1c8d53c73c0"/>
					<chartTitle position="Top"/>
					<chartSubtitle/>
					<chartLegend position="Top"/>
				</chart>
				<categoryDataset>
					<categorySeries>
						<seriesExpression><![CDATA["GANANCIAS SEMANALES"]]></seriesExpression>
						<categoryExpression><![CDATA[$F{semana}]]></categoryExpression>
						<valueExpression><![CDATA[$F{ganancias_totales}]]></valueExpression>
					</categorySeries>
				</categoryDataset>
				<barPlot isShowLabels="true" isShowTickMarks="true">
					<plot>
						<seriesColor seriesOrder="0" color="#FF3333"/>
					</plot>
					<itemLabel/>
					<categoryAxisFormat>
						<axisFormat/>
					</categoryAxisFormat>
					<valueAxisFormat>
						<axisFormat/>
					</valueAxisFormat>
				</barPlot>
			</barChart>
		</band>
	</summary>
</jasperReport>
